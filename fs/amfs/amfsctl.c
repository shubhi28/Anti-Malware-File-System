#include <asm/unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <sys/ioctl.h>
#include <unistd.h>
#include <openssl/md5.h>
#include <fcntl.h>
#include "amfsctl.h"

#define MAX_PATTERNLIST_CHARS 256*256
#define MAX_PATTERN_CHARS 256

int main(int argc, char *argv[])
{
	extern char *optarg;
	extern int optind, optopt;
        
        int fd=0, rc=0;
	int flagl=0;
        int flaga=0;
        int flagr=0;
        int error=0;
        
	char *pattern;
	const char *pattern_file_path;
	char *mypattern_list;
	mypattern_list = (char *)malloc(MAX_PATTERNLIST_CHARS);
	pattern = (char*)malloc(MAX_PATTERN_CHARS);
        while(1){
                int c ;
                c= getopt(argc, argv, ":la:r:h");
                if (c == -1)
                        break;
                switch(c){
                        case 'l':
                                flagl +=1;
                                break;
                        case 'a':
                      		pattern = optarg;
                               	flaga+=1;
                                break;
                        case 'r':
                              	pattern = optarg;
                               	flagr+=1;
                                break;
                        case 'h':
                                printf("Use -l option to list patterns\n");
				printf("Use -a option to add new pattern\n");
				printf("Use -r option to remove existing pattern\n");
                                break;
                        case ':':
                                printf("Option -%c requires argument\n",optopt);
                                error+=1;
                                break;
			}
        	}

	if(flagl){
                if(flaga || flagr){
			printf("Pattern can either be listed, added or removed!!!\n");
			exit(2);
                }
        }
	
	if(flaga){
                if(flagl || flagr){
                        printf("Pattern can either be listed, added or removed!!!\n");
                        exit(2);
                }
        }

	if(flagr){
                if(flaga || flagl){
                        printf("Pattern can either be listed, added or removed!!!\n");
                        exit(2);
                }
        }

        if(error) {
                printf("Invalid arguments are provided\n");
                exit(2);
        }

        if(optind!= argc -1){
                printf("Missing arguments\n");
                exit(0);
        }
	pattern_file_path = argv[optind++];

	fd = open(pattern_file_path, O_RDONLY);
	if(fd < 1){
		printf("Pattern file cannot be opened!!!\n");
		return -1;
	}
	
	/* IOCTL for listing pattern*/
	if(flagl==1){
		rc = ioctl(fd,AMFS_LIST_PATTERN,mypattern_list);
		if(rc < 0){
			printf("Unable to list patterns\n");
			goto out;;
		}
		printf("%s", mypattern_list);
	}
	/*IOCTL for adding pattern*/
	else if(flaga==1){
                rc = ioctl(fd,AMFS_ADD_PATTERN,pattern);
                if(rc < 0){
                        perror("Unable to add patterns\n");
                	goto out;
		}
        }
	/*IOCTL for removing pattern*/
	else if(flagr==1){
                rc = ioctl(fd,AMFS_REMOVE_PATTERN,pattern);
                if(rc < 0){
                        printf("Unable to remove patterns\n");
                	goto out;
		}
        }

out:
	return rc;
}

